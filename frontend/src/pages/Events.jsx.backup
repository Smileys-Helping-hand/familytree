import { useState } from 'react';
import { useParams } from 'react-router-dom';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { eventAPI } from '../services/api';
import { motion, AnimatePresence } from 'framer-motion';
import { Calendar, Plus, X, MapPin, Clock, Users, ChevronLeft, ChevronRight, Cake, Heart, PartyPopper, Gift } from 'lucide-react';
import toast from 'react-hot-toast';
import { format, startOfMonth, endOfMonth, eachDayOfInterval, isSameMonth, isSameDay, addMonths, subMonths, isToday, isBefore } from 'date-fns';

export default function Events() {
  const { familyId } = useParams();
  const queryClient = useQueryClient();
  const [currentDate, setCurrentDate] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [viewMode, setViewMode] = useState('calendar'); // 'calendar' or 'list'

  const { data: eventsData, isLoading } = useQuery({
    queryKey: ['events', familyId],
    queryFn: () => eventAPI.getAll(familyId),
  });

  const { data: upcomingData } = useQuery({
    queryKey: ['events', 'upcoming'],
    queryFn: eventAPI.getUpcoming,
  });

  const events = eventsData?.data?.events || [];
  const upcomingEvents = upcomingData?.data?.events || [];

  const deleteMutation = useMutation({
    mutationFn: (eventId) => eventAPI.delete(eventId),
    onSuccess: () => {
      queryClient.invalidateQueries(['events']);
      toast.success('Event deleted');
    },
  });

  const rsvpMutation = useMutation({
    mutationFn: ({ eventId, status }) => eventAPI.rsvp(eventId, status),
    onSuccess: () => {
      queryClient.invalidateQueries(['events']);
      toast.success('RSVP updated!');
    },
  });

  // Get events for selected date
  const eventsOnDate = events.filter(event =>
    isSameDay(new Date(event.date), selectedDate)
  );

  if (isLoading) {
    return (
      <div className="flex justify-center items-center min-h-[400px]">
        <motion.div
          animate={{ rotate: 360 }}
          transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
          className="rounded-full h-12 w-12 border-4 border-primary-600 border-t-transparent"
        />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <motion.div
        className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
        initial={{ y: -20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
      >
        <div>
          <h1 className="text-3xl font-bold gradient-text">Family Events</h1>
          <p className="text-gray-600 mt-1">Never miss a special moment</p>
        </div>
        <div className="flex gap-3">
          <motion.button
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            onClick={() => setViewMode(viewMode === 'calendar' ? 'list' : 'calendar')}
            className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
          >
            {viewMode === 'calendar' ? 'List View' : 'Calendar View'}
          </motion.button>
          <motion.button
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            onClick={() => setShowCreateModal(true)}
            className="btn btn-primary flex items-center gap-2"
          >
            <Plus size={20} />
            Create Event
          </motion.button>
        </div>
      </motion.div>

      {/* Upcoming Events Ticker */}
      {upcomingEvents.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: -10 }}
          animate={{ opacity: 1, y: 0 }}
          className="bg-gradient-to-r from-primary-500 to-purple-500 rounded-lg p-4 text-white overflow-hidden relative"
        >
          <div className="flex items-center gap-3">
            <PartyPopper className="flex-shrink-0" size={24} />
            <div className="flex-1 overflow-hidden">
              <motion.div
                animate={{ x: ['0%', '-50%'] }}
                transition={{ duration: 20, repeat: Infinity, ease: 'linear' }}
                className="whitespace-nowrap"
              >
                {upcomingEvents.map((event, i) => (
                  <span key={event._id} className="inline-flex items-center gap-2 mr-8">
                    <strong>{event.title}</strong> - {format(new Date(event.date), 'MMM d')}
                    {i < upcomingEvents.length - 1 && <span className="mx-4">â€¢</span>}
                  </span>
                ))}
                {upcomingEvents.map((event, i) => (
                  <span key={`${event._id}-dup`} className="inline-flex items-center gap-2 mr-8">
                    <strong>{event.title}</strong> - {format(new Date(event.date), 'MMM d')}
                    {i < upcomingEvents.length - 1 && <span className="mx-4">â€¢</span>}
                  </span>
                ))}
              </motion.div>
            </div>
          </div>
        </motion.div>
      )}

      {viewMode === 'calendar' ? (
        <div className="grid lg:grid-cols-3 gap-6">
          {/* Calendar */}
          <div className="lg:col-span-2">
            <CalendarView
              currentDate={currentDate}
              setCurrentDate={setCurrentDate}
              selectedDate={selectedDate}
              setSelectedDate={setSelectedDate}
              events={events}
            />
          </div>

          {/* Events on Selected Date */}
          <div className="card">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">
              {format(selectedDate, 'MMMM d, yyyy')}
            </h3>
            {eventsOnDate.length === 0 ? (
              <div className="text-center py-12">
                <Calendar className="mx-auto text-gray-300 mb-3" size={48} />
                <p className="text-gray-500 text-sm">No events on this day</p>
              </div>
            ) : (
              <div className="space-y-3">
                {eventsOnDate.map((event) => (
                  <EventCard
                    key={event._id}
                    event={event}
                    onDelete={(id) => deleteMutation.mutate(id)}
                    onRSVP={(id, status) => rsvpMutation.mutate({ eventId: id, status })}
                  />
                ))}
              </div>
            )}
          </div>
        </div>
      ) : (
        <EventsList
          events={events}
          onDelete={(id) => deleteMutation.mutate(id)}
          onRSVP={(id, status) => rsvpMutation.mutate({ eventId: id, status })}
        />
      )}

      {/* Create Event Modal */}
      <CreateEventModal
        isOpen={showCreateModal}
        onClose={() => setShowCreateModal(false)}
        familyId={familyId}
      />
    </div>
  );
}

// Calendar View Component
function CalendarView({ currentDate, setCurrentDate, selectedDate, setSelectedDate, events }) {
  const monthStart = startOfMonth(currentDate);
  const monthEnd = endOfMonth(currentDate);
  const days = eachDayOfInterval({ start: monthStart, end: monthEnd });

  // Get events for a specific day
  const getEventsForDay = (day) => {
    return events.filter(event => isSameDay(new Date(event.date), day));
  };

  // Get event icon
  const getEventIcon = (type) => {
    switch (type) {
      case 'birthday': return <Cake size={12} />;
      case 'anniversary': return <Heart size={12} />;
      case 'reunion': return <Users size={12} />;
      default: return <PartyPopper size={12} />;
    }
  };

  return (
    <motion.div
      className="card"
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
    >
      {/* Calendar Header */}
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl font-bold text-gray-900">
          {format(currentDate, 'MMMM yyyy')}
        </h2>
        <div className="flex gap-2">
          <motion.button
            whileHover={{ scale: 1.1 }}
            whileTap={{ scale: 0.9 }}
            onClick={() => setCurrentDate(subMonths(currentDate, 1))}
            className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <ChevronLeft size={20} />
          </motion.button>
          <motion.button
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            onClick={() => setCurrentDate(new Date())}
            className="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
          >
            Today
          </motion.button>
          <motion.button
            whileHover={{ scale: 1.1 }}
            whileTap={{ scale: 0.9 }}
            onClick={() => setCurrentDate(addMonths(currentDate, 1))}
            className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <ChevronRight size={20} />
          </motion.button>
        </div>
      </div>

      {/* Weekday Headers */}
      <div className="grid grid-cols-7 gap-2 mb-2">
        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day) => (
          <div key={day} className="text-center text-sm font-medium text-gray-500 py-2">
            {day}
          </div>
        ))}
      </div>

      {/* Calendar Grid */}
      <div className="grid grid-cols-7 gap-2">
        {days.map((day, index) => {
          const dayEvents = getEventsForDay(day);
          const isSelected = isSameDay(day, selectedDate);
          const isCurrentDay = isToday(day);
          const isPast = isBefore(day, new Date()) && !isCurrentDay;

          return (
            <motion.button
              key={day.toString()}
              initial={{ opacity: 0, scale: 0.8 }}
              animate={{ opacity: 1, scale: 1 }}
              transition={{ delay: index * 0.01 }}
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              onClick={() => setSelectedDate(day)}
              className={`
                aspect-square p-2 rounded-lg text-sm relative
                ${isSelected ? 'bg-primary-600 text-white shadow-lg' : 'hover:bg-gray-100'}
                ${isCurrentDay && !isSelected ? 'border-2 border-primary-600 text-primary-600 font-bold' : ''}
                ${isPast && !isSelected ? 'text-gray-400' : ''}
                ${!isSameMonth(day, currentDate) ? 'text-gray-300' : ''}
              `}
            >
              <div className="flex flex-col items-center justify-center h-full">
                <span>{format(day, 'd')}</span>
                {dayEvents.length > 0 && (
                  <div className="flex gap-0.5 mt-1 flex-wrap justify-center">
                    {dayEvents.slice(0, 3).map((event, i) => (
                      <div
                        key={i}
                        className={`w-1.5 h-1.5 rounded-full ${
                          isSelected ? 'bg-white' : 'bg-primary-600'
                        }`}
                      />
                    ))}
                  </div>
                )}
              </div>
            </motion.button>
          );
        })}
      </div>

      {/* Legend */}
      <div className="mt-6 pt-6 border-t flex flex-wrap gap-4 text-sm">
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 rounded-full bg-primary-600"></div>
          <span className="text-gray-600">Has events</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 rounded-full border-2 border-primary-600"></div>
          <span className="text-gray-600">Today</span>
        </div>
      </div>
    </motion.div>
  );
}

// Event Card Component
function EventCard({ event, onDelete, onRSVP }) {
  const getEventColor = (type) => {
    switch (type) {
      case 'birthday': return 'from-pink-500 to-rose-500';
      case 'anniversary': return 'from-red-500 to-pink-500';
      case 'reunion': return 'from-blue-500 to-purple-500';
      default: return 'from-primary-500 to-purple-500';
    }
  };

  return (
    <motion.div
      initial={{ opacity: 0, x: -20 }}
      animate={{ opacity: 1, x: 0 }}
      whileHover={{ x: 4 }}
      className="relative overflow-hidden rounded-lg border border-gray-200 p-4 hover:shadow-lg transition-shadow"
    >
      <div className={`absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b ${getEventColor(event.type)}`} />
      <div className="ml-2">
        <h4 className="font-semibold text-gray-900 mb-1">{event.title}</h4>
        {event.description && (
          <p className="text-sm text-gray-600 mb-2">{event.description}</p>
        )}
        <div className="flex flex-wrap gap-3 text-xs text-gray-500 mb-3">
          <span className="flex items-center gap-1">
            <Clock size={12} />
            {event.time || 'All day'}
          </span>
          {event.location && (
            <span className="flex items-center gap-1">
              <MapPin size={12} />
              {event.location}
            </span>
          )}
        </div>
        <div className="flex gap-2">
          <button
            onClick={() => onRSVP(event._id, 'attending')}
            className="text-xs px-3 py-1 bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition-colors"
          >
            âœ“ Going
          </button>
          <button
            onClick={() => onRSVP(event._id, 'maybe')}
            className="text-xs px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full hover:bg-yellow-200 transition-colors"
          >
            ? Maybe
          </button>
        </div>
      </div>
    </motion.div>
  );
}

// Events List View Component
function EventsList({ events, onDelete, onRSVP }) {
  const sortedEvents = [...events].sort((a, b) => new Date(a.date) - new Date(b.date));

  return (
    <motion.div
      className="card"
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
    >
      <div className="space-y-4">
        {sortedEvents.map((event, index) => (
          <motion.div
            key={event._id}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: index * 0.05 }}
            className="flex items-start gap-4 p-4 rounded-lg border border-gray-200 hover:shadow-lg transition-shadow"
          >
            <div className="flex-shrink-0 w-16 text-center">
              <div className="text-2xl font-bold text-primary-600">
                {format(new Date(event.date), 'd')}
              </div>
              <div className="text-xs text-gray-500 uppercase">
                {format(new Date(event.date), 'MMM')}
              </div>
            </div>
            <div className="flex-1">
              <h3 className="font-semibold text-gray-900 mb-1">{event.title}</h3>
              <p className="text-sm text-gray-600 mb-2">{event.description}</p>
              <div className="flex flex-wrap gap-3 text-xs text-gray-500">
                <span className="flex items-center gap-1">
                  <Clock size={12} />
                  {event.time || 'All day'}
                </span>
                {event.location && (
                  <span className="flex items-center gap-1">
                    <MapPin size={12} />
                    {event.location}
                  </span>
                )}
                <span className="capitalize px-2 py-0.5 rounded-full bg-primary-100 text-primary-700">
                  {event.type}
                </span>
              </div>
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => onRSVP(event._id, 'attending')}
                className="text-xs px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200"
              >
                Going
              </button>
            </div>
          </motion.div>
        ))}
      </div>
    </motion.div>
  );
}

// Create Event Modal Component
function CreateEventModal({ isOpen, onClose, familyId }) {
  const queryClient = useQueryClient();
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    date: '',
    time: '',
    location: '',
    type: 'celebration',
  });

  const createMutation = useMutation({
    mutationFn: (data) => eventAPI.create({ ...data, family: familyId }),
    onSuccess: () => {
      queryClient.invalidateQueries(['events']);
      toast.success('ðŸŽ‰ Event created!');
      onClose();
      setFormData({ title: '', description: '', date: '', time: '', location: '', type: 'celebration' });
    },
    onError: () => {
      toast.error('Failed to create event');
    },
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.title || !formData.date) {
      toast.error('Please fill in required fields');
      return;
    }
    createMutation.mutate(formData);
  };

  if (!isOpen) return null;

  return (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
        onClick={onClose}
      >
        <motion.div
          initial={{ scale: 0.9, opacity: 0 }}
          animate={{ scale: 1, opacity: 1 }}
          exit={{ scale: 0.9, opacity: 0 }}
          className="bg-white rounded-xl shadow-2xl max-w-lg w-full"
          onClick={(e) => e.stopPropagation()}
        >
          <div className="p-6">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-gray-900">Create Event</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X size={24} />
              </button>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Event Title *
                </label>
                <input
                  type="text"
                  value={formData.title}
                  onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                  placeholder="Family Reunion"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Description
                </label>
                <textarea
                  value={formData.description}
                  onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                  rows="3"
                  placeholder="Describe the event..."
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Date *
                  </label>
                  <input
                    type="date"
                    value={formData.date}
                    onChange={(e) => setFormData(prev => ({ ...prev, date: e.target.value }))}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                    required
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Time
                  </label>
                  <input
                    type="time"
                    value={formData.time}
                    onChange={(e) => setFormData(prev => ({ ...prev, time: e.target.value }))}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Location
                </label>
                <input
                  type="text"
                  value={formData.location}
                  onChange={(e) => setFormData(prev => ({ ...prev, location: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                  placeholder="123 Family St"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Event Type
                </label>
                <select
                  value={formData.type}
                  onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                >
                  <option value="celebration">Celebration</option>
                  <option value="birthday">Birthday</option>
                  <option value="anniversary">Anniversary</option>
                  <option value="reunion">Reunion</option>
                  <option value="other">Other</option>
                </select>
              </div>

              <div className="flex gap-3 pt-4">
                <button
                  type="button"
                  onClick={onClose}
                  className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={createMutation.isPending}
                  className="flex-1 btn btn-primary disabled:opacity-50"
                >
                  {createMutation.isPending ? 'Creating...' : 'Create Event'}
                </button>
              </div>
            </form>
          </div>
        </motion.div>
      </motion.div>
    </AnimatePresence>
  );
}
